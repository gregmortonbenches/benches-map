<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benches Map</title>

  <!-- Favicon fix -->
  <link rel="icon" href="data:,">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* Your existing CSS... */
    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 18px;
      cursor: pointer;
      color: #bbb;
    }

    .star-rating input:checked ~ label {
      color: gold;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold;
    }

    .fade-message {
      margin-top: 4px;
      color: #4caf50;
      font-size: 13px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .fade-message.hidden {
      opacity: 0;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>Benches Map</h1>
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Search UK place..." />
      <button onclick="searchLocation()">Search</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAg-VG3laAp8kvel5mC9Q_kWhLv6xvFTPY",
      authDomain: "bench-rating.firebaseapp.com",
      projectId: "bench-rating",
      storageBucket: "bench-rating.firebasestorage.app",
      messagingSenderId: "601862513386",
      appId: "1:601862513386:web:485fa761244ea436a4ad93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ratingCache = {};

    const map = L.map('map', {
      maxBounds: [[48.5, -11], [61.5, 4]],
      maxBoundsViscosity: 1.0
    }).setView([54.5, -3], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const benchIcon = L.divIcon({
      className: 'emoji-marker',
      html: 'ðŸª‘',
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    // Load GeoJSON data and create markers
    // Assuming you have the logic to load the geojson data here, similar to the previous code

    function loadRatings(benchId) {
      if (ratingCache[benchId]) {
        updateRatingUI(benchId, ratingCache[benchId]);
        return;
      }

      db.collection('benches').doc(benchId).get()
        .then(doc => {
          const ratings = doc.data() || {};
          ratingCache[benchId] = ratings;
          updateRatingUI(benchId, ratings);
        })
        .catch(err => console.error(err));
    }

    function updateRatingUI(benchId, ratings) {
      const { comfort, view, ambience } = ratings;

      if (comfort && view && ambience) {
        document.getElementById(`comfort-${benchId}`).querySelector(`input[value="${comfort}"]`).checked = true;
        document.getElementById(`view-${benchId}`).querySelector(`input[value="${view}"]`).checked = true;
        document.getElementById(`ambience-${benchId}`).querySelector(`input[value="${ambience}"]`).checked = true;
      }

      const ratingContainer = document.getElementById(`rating-${benchId}`);
      const avgRating = ((comfort + view + ambience) / 3).toFixed(1);
      ratingContainer.innerHTML = `Avg: ${avgRating} â˜…`;

      document.getElementById(`message-${benchId}`).classList.add('hidden');
    }

    function updateFirebaseRating(benchId, comfort, view, ambience) {
      const avgRating = (comfort + view + ambience) / 3;
      db.collection('benches').doc(benchId).set({
        comfort,
        view,
        ambience,
        average: avgRating
      })
      .then(() => {
        console.log("Rating updated successfully");
      })
      .catch(err => console.error("Error updating rating:", err));
    }

    function handleRatingChange(benchId) {
      const comfort = parseInt(document.querySelector(`input[name="comfort-${benchId}"]:checked`)?.value) || 0;
      const view = parseInt(document.querySelector(`input[name="view-${benchId}"]:checked`)?.value) || 0;
      const ambience = parseInt(document.querySelector(`input[name="ambience-${benchId}"]:checked`)?.value) || 0;

      if (comfort && view && ambience) {
        updateFirebaseRating(benchId, comfort, view, ambience);
        const ratingContainer = document.getElementById(`rating-${benchId}`);
        const avgRating = ((comfort + view + ambience) / 3).toFixed(1);
        ratingContainer.innerHTML = `Avg: ${avgRating} â˜…`;

        const message = document.getElementById(`message-${benchId}`);
        message.classList.remove('hidden');
        setTimeout(() => {
          message.classList.add('hidden');
        }, 2000);
      }
    }

    function searchLocation() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (searchTerm.length > 0) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchTerm}`)
          .then(res => res.json())
          .then(data => {
            if (data && data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              map.setView([lat, lon], 12);
            }
          })
          .catch(err => console.error('Error searching location:', err));
      }
    }

    // Event listener for all star rating changes
    document.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input[type="radio"]')) {
        const benchId = e.target.name.split('-')[1];
        handleRatingChange(benchId);
      }
    });
  </script>
</body>
</html>
