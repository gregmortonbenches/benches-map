<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benches Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background-color: #121212; }
    #map { height: calc(100% - 60px); width: 100%; }
    .header { background-color: #1e1e1e; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; height: 60px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); border-bottom: 1px solid #333; border-radius: 0 0 12px 12px; }
    .header h1 { margin: 0; font-size: 18px; }
    .search-container { display: flex; align-items: center; gap: 8px; }
    .search-container input { padding: 6px; font-size: 14px; border-radius: 6px; border: none; background-color: #2a2a2a; color: #eee; }
    .search-container button { padding: 6px 10px; font-size: 14px; cursor: pointer; border: none; border-radius: 6px; background-color: #2196F3; color: white; }
    .emoji-marker { font-size: 20px; line-height: 1; }
    .popup { color: white; font-size: 14px; background-color: #1e1e1e; }
    .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #fff; border-top: 2px solid #444; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 4px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-message { margin-top: 4px; color: #4caf50; font-size: 13px; opacity: 1; transition: opacity 0.3s ease; }
    .fade-message.hidden { opacity: 0; }
    .star { cursor: pointer; color: #ccc; font-size: 22px; user-select: none; }
    .star.filled { color: gold; }
    .star.disabled { pointer-events: none; color: #eee; }
    .combined-rating { margin-top: 8px; font-size: 1.1em; }
    .star-rating { display: inline-block; }
    @media (max-width: 500px) {
      .header { flex-direction: column; align-items: flex-start; height: auto; }
      .search-container { width: 100%; margin-top: 5px; }
      .search-container input { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Benches Map</h1>
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Search UK place..." />
      <button onclick="searchLocation()">Search</button>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAg-VG3laAp8kvel5mC9Q_kWhLv6xvFTPY",
      authDomain: "bench-rating.firebaseapp.com",
      projectId: "bench-rating",
      storageBucket: "bench-rating.firebasestorage.app",
      messagingSenderId: "601862513386",
      appId: "1:601862513386:web:485fa761244ea436a4ad93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ratingCategories = ['comfort', 'ambience', 'view'];

    const map = L.map('map', {
      maxBounds: [[48.5, -11], [61.5, 4]],
      maxBoundsViscosity: 1.0
    }).setView([54.5, -3], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const benchIcon = L.divIcon({
      className: 'emoji-marker',
      html: 'ðŸª‘',
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    function renderStars(rating, max = 5, benchId = "", category = "", disabled = false) {
      let stars = '';
      for (let i = 1; i <= max; i++) {
        stars += `<span class="star${i <= rating ? ' filled' : ''}${disabled ? ' disabled' : ''}" data-value="${i}" data-bench="${benchId}" data-cat="${category}">&#9733;</span>`;
      }
      return stars;
    }

    function getUserRatingKey(benchId) {
      return `benchRated_${benchId}`;
    }

    function createPopupContent(props, benchId, name) {
      const extraKeys = ['material', 'colour', 'seats', 'backrest'];
      const extras = extraKeys.filter(k => props[k]).map(k =>
        `<div><strong>${k}:</strong> ${props[k]}</div>`
      ).join('');
      let categoriesHtml = ratingCategories.map(cat => `
        <div>
          <label>${cat.charAt(0).toUpperCase() + cat.slice(1)}:</label>
          <span id="avg-${cat}-${benchId}"><span class="spinner"></span></span>
          <div class="star-rating" id="star-row-${cat}-${benchId}" data-cat="${cat}" data-bench="${benchId}">
            ${renderStars(0, 5, benchId, cat, false)}
          </div>
        </div>
      `).join('');

      return `
        <div class="popup">
          <strong>${name}</strong>
          ${extras}
          <div>
            ${categoriesHtml}
            <div id="thanks-${benchId}" class="fade-message hidden">Thanks for rating!</div>
            <div id="combined-${benchId}" class="combined-rating"></div>
          </div>
        </div>
      `;
    }

    function loadAllRatings(benchId) {
      ratingCategories.forEach(cat => loadCategoryRating(benchId, cat));
      loadCombinedRating(benchId);
      // Disabling stars if already rated is handled below
    }

    function loadCategoryRating(benchId, category) {
      const avgEl = document.getElementById(`avg-${category}-${benchId}`);
      const starRow = document.getElementById(`star-row-${category}-${benchId}`);
      if (!avgEl || !starRow) return;
      avgEl.innerHTML = `<span class="spinner"></span>`;
      db.collection("benchRatings").doc(benchId).get()
        .then(doc => {
          let avg = 0, count = 0;
          if (doc.exists && doc.data()[category]) {
            const data = doc.data()[category];
            avg = data.total / data.count;
            count = data.count;
          }
          avgEl.innerHTML = count > 0
            ? `${renderStars(Math.round(avg))} (${count} ratings)`
            : "No ratings yet.";
          let disabled = !!localStorage.getItem(getUserRatingKey(benchId));
          starRow.innerHTML = renderStars(0, 5, benchId, category, disabled);
        });
    }

    function loadCombinedRating(benchId) {
      db.collection("benchRatings").doc(benchId).get()
        .then(doc => {
          let el = document.getElementById(`combined-${benchId}`);
          if (!el) return;
          let text = "";
          if (doc.exists) {
            const data = doc.data();
            let totalAvg = 0, validCats = 0;
            ratingCategories.forEach(cat => {
              if (data[cat] && data[cat].count > 0) {
                totalAvg += data[cat].total / data[cat].count;
                validCats++;
              }
            });
            if (validCats > 0) {
              const avg = totalAvg / validCats;
              text = `<strong>Overall average:</strong> ${renderStars(Math.round(avg))}`;
            }
          }
          el.innerHTML = text;
        });
    }

    function disableStars(benchId, category) {
      const starRow = document.getElementById(`star-row-${category}-${benchId}`);
      if (starRow) {
        starRow.innerHTML = renderStars(0, 5, benchId, category, true);
      }
    }

    function handleStarClick(benchId, category, value) {
      const starRow = document.getElementById(`star-row-${category}-${benchId}`);
      if (starRow) {
        let stars = starRow.querySelectorAll('.star');
        stars.forEach((star, idx) => {
          if (idx < value) {
            star.classList.add('filled');
          } else {
            star.classList.remove('filled');
          }
        });
      }
      submitStarRating(benchId, category, value);
    }

    function submitStarRating(benchId, category, value) {
      if (localStorage.getItem(getUserRatingKey(benchId))) return;
      const ref = db.collection("benchRatings").doc(benchId);
      ref.get().then(doc => {
        let update = {};
        if (doc.exists) {
          const data = doc.data();
          const cat = data[category] || { total: 0, count: 0 };
          update[category] = {
            total: cat.total + value,
            count: cat.count + 1
          };
        } else {
          update[category] = { total: value, count: 1 };
        }
        ref.set(update, { merge: true }).then(() => {
          const thanksEl = document.getElementById(`thanks-${benchId}`);
          if (thanksEl) {
            thanksEl.classList.remove('hidden');
            setTimeout(() => thanksEl.classList.add('hidden'), 2000);
          }
          localStorage.setItem(getUserRatingKey(benchId), '1');
          ratingCategories.forEach(cat => disableStars(benchId, cat));
          loadAllRatings(benchId);
        });
      });
    }

    // Attach listeners after popup is fully rendered.
    function attachStarListeners(benchId) {
      if (localStorage.getItem(getUserRatingKey(benchId))) return;
      ratingCategories.forEach(category => {
        const starRow = document.getElementById(`star-row-${category}-${benchId}`);
        if (!starRow) return;
        Array.from(starRow.querySelectorAll('.star')).forEach(star => {
          if (star.classList.contains('disabled')) return;
          star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));
            handleStarClick(benchId, category, value);
          });
        });
      });
    }

    // Ensure Firestore doc IDs never contain slashes!
    function sanitizeBenchId(rawId) {
      return String(rawId).replace(/\//g, "_");
    }

    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        const url = `data/tile_${row}_${col}.geojson`;
        fetch(url)
          .then(res => res.ok ? res.json() : Promise.reject(res.status))
          .then(data => {
            const layer = L.geoJSON(data, {
              pointToLayer: (feature, latlng) => {
                const props = feature.properties || {};
                // Sanitize the bench ID so no slashes from OSM IDs go into Firestore
                const benchIdRaw = props["@id"] || `${latlng.lat.toFixed(5)}_${latlng.lng.toFixed(5)}_${Math.floor(Math.random() * 1000)}`;
                const benchId = sanitizeBenchId(benchIdRaw);
                const name = props.name || "Unnamed Bench";
                const marker = L.marker(latlng, { icon: benchIcon });
                const popupContent = createPopupContent(props, benchId, name);
                marker.bindPopup(popupContent);

                marker.on('popupopen', function() {
                  loadAllRatings(benchId);
                  setTimeout(() => attachStarListeners(benchId), 0);
                });
                return marker;
              }
            });
            markerCluster.addLayer(layer);
          })
          .catch(err => console.warn(`Failed to load ${url}:`, err));
      }
    }

    function searchLocation() {
      const query = document.getElementById('searchInput').value;
      if (!query) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            alert("Place not found.");
            return;
          }
          const { lat, lon } = data[0];
          map.setView([parseFloat(lat), parseFloat(lon)], 15);
        })
        .catch(err => console.error('Geocoding error:', err));
    }
  </script>
</body>
</html>
