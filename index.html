<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benches Map</title>

  <!-- Favicon fix -->
  <link rel="icon" href="data:,">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background-color: #121212;
    }

    #map {
      height: calc(100% - 60px);
      width: 100%;
    }

    .header {
      background-color: #1e1e1e;
      color: white;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      height: 60px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid #333;
      border-radius: 0 0 12px 12px;
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
    }

    .search-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-container input {
      padding: 6px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background-color: #2a2a2a;
      color: #eee;
    }

    .search-container button {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #2196F3;
      color: white;
    }

    .emoji-marker {
      font-size: 20px;
      line-height: 1;
    }

    .popup {
      color: white;
      font-size: 14px;
      background-color: #1e1e1e;
    }

    .popup select {
      margin-top: 4px;
      background: #2a2a2a;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
    }

    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-top: 2px solid #444;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 4px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .fade-message {
      margin-top: 4px;
      color: #4caf50;
      font-size: 13px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .fade-message.hidden {
      opacity: 0;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 18px;
      cursor: pointer;
      color: #bbb;
    }

    .star-rating input:checked ~ label {
      color: gold;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold;
    }

    @media (max-width: 500px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        height: auto;
      }

      .search-container {
        width: 100%;
        margin-top: 5px;
      }

      .search-container input {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>Benches Map</h1>
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Search UK place..." />
      <button onclick="searchLocation()">Search</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAg-VG3laAp8kvel5mC9Q_kWhLv6xvFTPY",
      authDomain: "bench-rating.firebaseapp.com",
      projectId: "bench-rating",
      storageBucket: "bench-rating.firebasestorage.app",
      messagingSenderId: "601862513386",
      appId: "1:601862513386:web:485fa761244ea436a4ad93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ratingCache = {};

    const map = L.map('map', {
      maxBounds: [[48.5, -11], [61.5, 4]],
      maxBoundsViscosity: 1.0
    }).setView([54.5, -3], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const benchIcon = L.divIcon({
      className: 'emoji-marker',
      html: 'ðŸª‘',
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        const url = `data/tile_${row}_${col}.geojson`;
        fetch(url)
          .then(res => res.ok ? res.json() : Promise.reject(res.status))
          .then(data => {
            const layer = L.geoJSON(data, {
              pointToLayer: (feature, latlng) => {
                const props = feature.properties || {};
                const benchId = props["@id"] || `${latlng.lat.toFixed(5)}_${latlng.lng.toFixed(5)}_${Math.floor(Math.random() * 1000)}`;
                const name = props.name || "Unnamed Bench";

                const marker = L.marker(latlng, { icon: benchIcon });

                const extras = ['material', 'colour', 'seats', 'backrest']
                  .filter(key => props[key])
                  .map(key => `<div><strong>${key}:</strong> ${props[key]}</div>`)
                  .join('');

                const popupContent = `
                  <div class="popup">
                    <strong>${name}</strong>
                    ${extras}
                    <div id="rating-${benchId}"><span class="spinner"></span></div>
                    
                    <!-- Comfort Rating -->
                    <label for="comfort-${benchId}">Comfort:</label>
                    <div id="comfort-${benchId}" class="star-rating">
                      <input type="radio" name="comfort-${benchId}" value="1" /> â˜…
                      <input type="radio" name="comfort-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>
                    
                    <!-- View Rating -->
                    <label for="view-${benchId}">View:</label>
                    <div id="view-${benchId}" class="star-rating">
                      <input type="radio" name="view-${benchId}" value="1" /> â˜…
                      <input type="radio" name="view-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>
                    
                    <!-- Ambience Rating -->
                    <label for="ambience-${benchId}">Ambience:</label>
                    <div id="ambience-${benchId}" class="star-rating">
                      <input type="radio" name="ambience-${benchId}" value="1" /> â˜…
                      <input type="radio" name="ambience-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>

                    <div id="thanks-${benchId}" class="fade-message hidden">Thanks for rating!</div>
                  </div>
                `;

                marker.bindPopup(popupContent);
                marker.on('popupopen', () => loadRating(benchId));
                return marker;
              }
            });
            markerCluster.addLayer(layer);
          });
      }
    }

    function submitRating(benchId) {
      const comfortRating = parseInt(document.querySelector(`input[name="comfort-${benchId}"]:checked`)?.value);
      const viewRating = parseInt(document.querySelector(`input[name="view-${benchId}"]:checked`)?.value);
      const ambienceRating = parseInt(document.querySelector(`input[name="ambience-${benchId}"]:checked`)?.value);

      if (!comfortRating || !viewRating || !ambienceRating) return;

      const safeId = sanitizeId(benchId);
      const ref = db.collection("benchRatings").doc(safeId);

      ref.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          ref.set({
            comfortTotal: data.comfortTotal + comfortRating,
            comfortCount: data.comfortCount + 1,
            viewTotal: data.viewTotal + viewRating,
            viewCount: data.viewCount + 1,
            ambienceTotal: data.ambienceTotal + ambienceRating,
            ambienceCount: data.ambienceCount + 1
          }, { merge: true });
        } else {
          ref.set({
            comfortTotal: comfortRating,
            comfortCount: 1,
            viewTotal: viewRating,
            viewCount: 1,
            ambienceTotal: ambienceRating,
            ambienceCount: 1
          });
        }

        document.querySelectorAll(`#comfort-${benchId} input, #view-${benchId} input, #ambience-${benchId} input`)
          .forEach(input => input.disabled = true);

        const thanksEl = document.getElementById(`thanks-${benchId}`);
        if (thanksEl) {
          thanksEl.classList.remove('hidden');
          setTimeout(() => thanksEl.classList.add('hidden'), 2500);
        }

        setTimeout(() => loadRating(benchId), 500);
      });
    }

    function loadRating(benchId) {
      const safeId = sanitizeId(benchId);
      const el = document.getElementById(`rating-${benchId}`);
      if (!el) return;

      el.innerHTML = `<span class="spinner"></span>`;

      if (ratingCache[safeId]) {
        el.innerText = ratingCache[safeId];
        return;
      }

      db.collection("benchRatings").doc(safeId).get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            
            // Average ratings for comfort, view, and ambience
            const comfortAvg = data.comfortTotal / data.comfortCount;
            const viewAvg = data.viewTotal / data.viewCount;
            const ambienceAvg = data.ambienceTotal / data.ambienceCount;

            // Calculate overall average
            const overallAvg = (comfortAvg + viewAvg + ambienceAvg) / 3;

            const text = `Average Ratings:
                          Comfort: ${comfortAvg.toFixed(1)} (${data.comfortCount} ratings)
                          View: ${viewAvg.toFixed(1)} (${data.viewCount} ratings)
                          Ambience: ${ambienceAvg.toFixed(1)} (${data.ambienceCount} ratings)
                          Overall: ${overallAvg.toFixed(1)}`;

            el.innerText = text;
            ratingCache[safeId] = text;
          } else {
            el.innerText = "No ratings yet.";
            ratingCache[safeId] = "No ratings yet.";
          }
        })
        .catch(err => {
          el.innerText = "Rating failed to load.";
          console.error("Error loading rating:", err);
        });
    }

    function sanitizeId(benchId) {
      return benchId.replace(/\W+/g, '_');
    }

    function searchLocation() {
      const query = document.getElementById('searchInput').value;
      if (query) {
        const encodedQuery = encodeURIComponent(query);
        window.open(`https://www.google.com/maps/search/?q=${encodedQuery}`, '_blank');
      }
    }
  </script>
</body>
</html>
