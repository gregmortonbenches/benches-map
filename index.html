<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benches Map</title>

  <!-- Favicon fix -->
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #222;
      color: white;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100vh;
    }

    .popup {
      font-size: 16px;
      color: white;
    }

    .emoji-marker {
      font-size: 24px;
    }

    .star-rating {
      display: flex;
      justify-content: space-between;
      width: 120px;
      margin-bottom: 10px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating input + label {
      font-size: 20px;
      color: gray;
      cursor: pointer;
    }

    .star-rating input:checked + label {
      color: gold;
    }

    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    .fade-message {
      color: green;
      font-weight: bold;
      opacity: 0;
      transition: opacity 1s ease-out;
    }

    .fade-message.show {
      opacity: 1;
    }
  </style>

</head>
<body>

  <!-- Search Bar -->
  <div style="position: absolute; z-index: 1000; top: 10px; left: 50%; transform: translateX(-50%);">
    <input id="searchInput" type="text" placeholder="Search for a location" oninput="searchLocation()" style="padding: 10px; font-size: 16px; width: 300px; border-radius: 5px;"/>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAg-VG3laAp8kvel5mC9Q_kWhLv6xvFTPY",
      authDomain: "bench-rating.firebaseapp.com",
      projectId: "bench-rating",
      storageBucket: "bench-rating.firebasestorage.app",
      messagingSenderId: "601862513386",
      appId: "1:601862513386:web:485fa761244ea436a4ad93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ratingCache = {};

    const map = L.map('map', {
      maxBounds: [[48.5, -11], [61.5, 4]],
      maxBoundsViscosity: 1.0
    }).setView([54.5, -3], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const benchIcon = L.divIcon({
      className: 'emoji-marker',
      html: 'ðŸª‘',
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        const url = `data/tile_${row}_${col}.geojson`;
        fetch(url)
          .then(res => res.ok ? res.json() : Promise.reject(res.status))
          .then(data => {
            const layer = L.geoJSON(data, {
              pointToLayer: (feature, latlng) => {
                const props = feature.properties || {};
                const benchId = props["@id"] || `${latlng.lat.toFixed(5)}_${latlng.lng.toFixed(5)}_${Math.floor(Math.random() * 1000)}`;
                const name = props.name || "Unnamed Bench";

                const marker = L.marker(latlng, { icon: benchIcon });

                const extras = ['material', 'colour', 'seats', 'backrest']
                  .filter(key => props[key])
                  .map(key => `<div><strong>${key}:</strong> ${props[key]}</div>`)
                  .join('');

                const popupContent = `
                  <div class="popup">
                    <strong>${name}</strong>
                    ${extras}
                    <div id="rating-${benchId}"><span class="spinner"></span></div>
                    
                    <!-- Comfort Rating -->
                    <label for="comfort-${benchId}">Comfort:</label>
                    <div id="comfort-${benchId}" class="star-rating">
                      <input type="radio" name="comfort-${benchId}" value="1" /> â˜…
                      <input type="radio" name="comfort-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="comfort-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>
                    
                    <!-- View Rating -->
                    <label for="view-${benchId}">View:</label>
                    <div id="view-${benchId}" class="star-rating">
                      <input type="radio" name="view-${benchId}" value="1" /> â˜…
                      <input type="radio" name="view-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="view-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>
                    
                    <!-- Ambience Rating -->
                    <label for="ambience-${benchId}">Ambience:</label>
                    <div id="ambience-${benchId}" class="star-rating">
                      <input type="radio" name="ambience-${benchId}" value="1" /> â˜…
                      <input type="radio" name="ambience-${benchId}" value="2" /> â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="3" /> â˜…â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="4" /> â˜…â˜…â˜…â˜…
                      <input type="radio" name="ambience-${benchId}" value="5" /> â˜…â˜…â˜…â˜…â˜…
                    </div>

                    <div id="thanks-${benchId}" class="fade-message hidden">Thanks for rating!</div>
                  </div>
                `;

                marker.bindPopup(popupContent);
                marker.on('popupopen', () => loadRating(benchId));
                return marker;
              }
            });
            markerCluster.addLayer(layer);
          });
      }
    }

    function submitRating(benchId) {
      const comfortRating = parseInt(document.querySelector(`input[name="comfort-${benchId}"]:checked`)?.value);
      const viewRating = parseInt(document.querySelector(`input[name="view-${benchId}"]:checked`)?.value);
      const ambienceRating = parseInt(document.querySelector(`input[name="ambience-${benchId}"]:checked`)?.value);

      if (!comfortRating || !viewRating || !ambienceRating) return;

      const safeId = sanitizeId(benchId);
      const ref = db.collection("benchRatings").doc(safeId);

      ref.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          ref.set({
            comfortTotal: data.comfortTotal + comfortRating,
            comfortCount: data.comfortCount + 1,
            viewTotal: data.viewTotal + viewRating,
            viewCount: data.viewCount + 1,
            ambienceTotal: data.ambienceTotal + ambienceRating,
            ambienceCount: data.ambienceCount + 1
          }, { merge: true }).then(() => {
            document.querySelector(`#thanks-${benchId}`).classList.add("show");
            setTimeout(() => document.querySelector(`#thanks-${benchId}`).classList.remove("show"), 2000);
            loadRating(benchId);
          });
        } else {
          ref.set({
            comfortTotal: comfortRating,
            comfortCount: 1,
            viewTotal: viewRating,
            viewCount: 1,
            ambienceTotal: ambienceRating,
            ambienceCount: 1
          }).then(() => {
            document.querySelector(`#thanks-${benchId}`).classList.add("show");
            setTimeout(() => document.querySelector(`#thanks-${benchId}`).classList.remove("show"), 2000);
            loadRating(benchId);
          });
        }
      });
    }

    function loadRating(benchId) {
      const safeId = sanitizeId(benchId);
      const ref = db.collection("benchRatings").doc(safeId);

      ref.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          const comfortAvg = (data.comfortTotal / data.comfortCount).toFixed(1);
          const viewAvg = (data.viewTotal / data.viewCount).toFixed(1);
          const ambienceAvg = (data.ambienceTotal / data.ambienceCount).toFixed(1);
          const overallAvg = ((parseFloat(comfortAvg) + parseFloat(viewAvg) + parseFloat(ambienceAvg)) / 3).toFixed(1);

          document.querySelector(`#rating-${benchId}`).innerHTML = `
            Comfort: ${comfortAvg}â˜… | View: ${viewAvg}â˜… | Ambience: ${ambienceAvg}â˜… | Overall: ${overallAvg}â˜…
          `;
        }
      });
    }

    function sanitizeId(id) {
      return id.replace(/\./g, "_");
    }
  </script>

</body>
</html>
